<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expo Games WebSocket API 文檔</title>
    <link rel="stylesheet" href="/static/css/websocket-docs.css">
    <script src="/static/js/websocket-docs.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔌 Expo Games WebSocket API</h1>
            <p>即時雙向通訊協議文檔與測試工具</p>
        </div>

        <!-- 連接狀態指示器 -->
        <div class="endpoint-card">
            <div class="endpoint-header">
                <div>
                    <span class="status-indicator status-disconnected" id="connectionStatus"></span>
                    <strong>WebSocket 連接狀態</strong>
                    <div class="endpoint-description">目前連接狀態和控制</div>
                </div>
            </div>
            <div class="endpoint-content">
                <div class="test-section">
                    <h4>🔗 連接測試</h4>
                    <div class="input-group">
                        <label>WebSocket URL:</label>
                        <input type="text" id="wsUrl" value="" readonly>
                    </div>
                    <div class="test-controls">
                        <button class="btn btn-primary" id="connectBtn">連接</button>
                        <button class="btn btn-danger" id="disconnectBtn">斷開</button>
                        <button class="btn btn-success" id="clearLogBtn">清除日誌</button>
                    </div>
                    <div class="log-area" id="logArea">等待連接...\n</div>
                </div>
            </div>
        </div>

        <!-- 情緒分析 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/emotion</span>
                    <div class="endpoint-description">即時情緒分析串流</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>處理即時攝影機影像串流，進行情緒分析並返回結果。支援心跳機制和自動重連。</p>
                </div>

                <div class="section">
                    <h3>📤 客戶端發送訊息</h3>

                    <div class="message-example">
                        <div class="message-type">影像幀訊息 (Frame Message)</div>
                        <pre>{
  "type": "frame",
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "timestamp": 1640995200.123
}</pre>
                        <p><strong>說明</strong>：持續發送攝影機幀進行即時分析，建議 5-10 FPS</p>
                    </div>

                    <div class="message-example">
                        <div class="message-type">心跳訊息 (Ping Message - 可選)</div>
                        <pre>{
  "type": "ping",
  "timestamp": 1640995200.123
}</pre>
                        <p><strong>說明</strong>：心跳為可選功能，因為持續的幀數據已起到保活作用</p>
                    </div>
                </div>

                <div class="section">
                    <h3>📥 服務器回應訊息</h3>

                    <div class="message-example">
                        <div class="message-type">分析結果 (Result Message)</div>
                        <pre>{
  "type": "result",
  "emotion_zh": "開心",
  "emotion_en": "happy",
  "emoji": "😊",
  "confidence": 0.95,
  "timestamp": 1640995200.123,
  "frame_time": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">錯誤訊息 (Error Message)</div>
                        <pre>{
  "type": "error",
  "message": "影像分析錯誤: 無法檢測到人臉",
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">心跳回應 (Pong Response)</div>
                        <pre>"pong"</pre>
                        <p><strong>說明</strong>：服務端回應純文本 "pong"，不是 JSON 格式</p>
                    </div>
                </div>

                <div class="section">
                    <h3>🔌 連接管理</h3>
                    
                    <h4>連接方式</h4>
                    <div class="code-block">// 直接連接，無需 open 訊息
const ws = new WebSocket('ws://localhost:8896/ws/emotion');

ws.onopen = () => {
    console.log('已連接，可以開始發送影像幀');
    // 無需發送 open 訊息，直接發送 frame
};
</div>

                    <h4>停止會話</h4>
                    <div class="code-block">// 方法 1: 直接關閉連接（推薦）
ws.close(1000, '用戶主動關閉');

// 方法 2: 停止發送幀，保持連接
// 只要停止發送 frame 訊息即可，不需要特殊的停止訊息
clearInterval(frameInterval);
</div>

                    <h4>心跳機制（可選）</h4>
                    <div class="code-block">// 如果需要額外的心跳保活
setInterval(() => {
    if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
    }
}, 30000); // 每 30 秒一次
</div>
                </div>

                <div class="section">
                    <h3>⚙️ 效能參數</h3>
                    <table class="table">
                        <tr><th>參數</th><th>建議值</th><th>說明</th></tr>
                        <tr><td>幀率</td><td>5-10 FPS</td><td>視網路和處理能力而定</td></tr>
                        <tr><td>影像解析度</td><td>動態適應</td><td>自動適應攝影機實際解析度 (如 1920x1080, 1280x720 等)</td></tr>
                        <tr><td>壓縮品質</td><td>0.8 JPEG</td><td>平衡檔案大小和品質</td></tr>
                        <tr><td>網路延遲</td><td>< 200ms</td><td>建議延遲上限</td></tr>
                    </table>
                </div>

                <div class="section">
                    <h3>💻 使用範例</h3>
                    <div class="code-block">// JavaScript 動態解析度影像串流範例
class EmotionStreamClient {
    constructor() {
        this.websocket = null;
        this.videoSize = [640, 480]; // 默認值，會動態調整
        this.captureCanvas = null;
        this.captureContext = null;
    }

    async initializeCamera() {
        // 請求攝影機權限
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 640 }, height: { ideal: 480 } }
        });

        // 動態獲取實際解析度
        const videoTrack = stream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        this.videoSize = [
            settings.width || 640,
            settings.height || 480
        ];

        console.log('攝影機實際解析度:', this.videoSize);

        // 創建動態尺寸的捕獲畫布
        this.captureCanvas = document.createElement('canvas');
        this.captureCanvas.width = this.videoSize[0];
        this.captureCanvas.height = this.videoSize[1];
        this.captureContext = this.captureCanvas.getContext('2d');

        // 設置video元素
        const videoElement = document.createElement('video');
        videoElement.srcObject = stream;
        videoElement.play();

        return videoElement;
    }

    startStreaming(videoElement) {
        // 定期發送影像幀
        setInterval(() => {
            if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                // 使用動態解析度捕獲影像
                this.captureContext.drawImage(videoElement, 0, 0, this.videoSize[0], this.videoSize[1]);
                const imageData = this.captureCanvas.toDataURL('image/jpeg', 0.8);

                const message = {
                    type: 'frame',
                    image: imageData,
                    timestamp: Date.now() / 1000
                };

                this.websocket.send(JSON.stringify(message));
            }
        }, 200); // 5 FPS
    }
}</div>
                </div>
            </div>
        </div>

        <!-- 動作檢測 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/action</span>
                    <div class="endpoint-description">動作檢測狀態廣播</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>即時廣播動作檢測遊戲的狀態更新和結果。</p>
                </div>

                <div class="section">
                    <h3>📥 廣播訊息格式</h3>

                    <div class="message-example">
                        <div class="message-type">遊戲開始 (Game Start)</div>
                        <pre>{
  "channel": "action",
  "type": "game_start",
  "difficulty": "medium",
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">檢測結果 (Detection Result)</div>
                        <pre>{
  "channel": "action",
  "type": "detection_result",
  "action": "jump",
  "confidence": 0.87,
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">狀態更新 (Status Update)</div>
                        <pre>{
  "channel": "action",
  "type": "status_update",
  "status": "running",
  "current_action": "raise_hand",
  "time_remaining": 45.2,
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 手勢識別 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/gesture</span>
                    <div class="endpoint-description">手勢識別結果廣播</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>即時廣播手勢識別結果和狀態更新。</p>
                </div>

                <div class="section">
                    <h3>📥 廣播訊息格式</h3>

                    <div class="message-example">
                        <div class="message-type">手勢檢測 (Gesture Detected)</div>
                        <pre>{
  "channel": "gesture",
  "type": "gesture_detected",
  "gesture": "thumbs_up",
  "confidence": 0.92,
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">狀態更新 (Status Update)</div>
                        <pre>{
  "channel": "gesture",
  "type": "status_update",
  "status": "running",
  "uptime": 30,
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 石頭剪刀布 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/rps</span>
                    <div class="endpoint-description">石頭剪刀布遊戲狀態</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>即時廣播石頭剪刀布遊戲的狀態和結果。</p>
                </div>

                <div class="section">
                    <h3>📥 廣播訊息格式</h3>

                    <div class="message-example">
                        <div class="message-type">回合結果 (Round Result)</div>
                        <pre>{
  "channel": "rps",
  "type": "round_result",
  "player_choice": "rock",
  "ai_choice": "paper",
  "result": "ai_win",
  "scores": {"player": 1, "ai": 2},
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">遊戲結束 (Game End)</div>
                        <pre>{
  "channel": "rps",
  "type": "game_end",
  "final_scores": {"player": 2, "ai": 3},
  "winner": "ai",
  "duration": 120.5,
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI 繪畫 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/drawing</span>
                    <div class="endpoint-description">AI 繪畫會話狀態</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>即時廣播AI繪畫會話的狀態和識別結果。</p>
                </div>

                <div class="section">
                    <h3>📥 廣播訊息格式</h3>

                    <div class="message-example">
                        <div class="message-type">繪畫識別 (Drawing Recognition)</div>
                        <pre>{
  "channel": "drawing",
  "type": "recognition_result",
  "recognized_shape": "circle",
  "confidence": 0.88,
  "bounding_box": [100, 150, 300, 250],
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">會話狀態 (Session Status)</div>
                        <pre>{
  "channel": "drawing",
  "type": "session_status",
  "status": "active",
  "stroke_count": 45,
  "canvas_size": [800, 600],
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 手勢繪畫 WebSocket -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">WS</span>
                    <span class="endpoint-url">/ws/drawing/gesture</span>
                    <div class="endpoint-description">即時手勢繪畫控制</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <div class="section">
                    <h3>📋 功能說明</h3>
                    <p>處理即時手勢控制的繪畫功能，支援空中手勢繪畫、顏色選擇和畫布清空。</p>
                </div>

                <div class="section">
                    <h3>📤 客戶端發送訊息</h3>

                    <div class="message-example">
                        <div class="message-type">啟動手勢繪畫 (Start Gesture Drawing)</div>
                        <pre>{
  "type": "start_gesture_drawing",
  "mode": "gesture_control",
  "color": "blue",
  "canvas_size": [720, 1280],
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">攝影機幀 (Camera Frame)</div>
                        <pre>{
  "type": "camera_frame",
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">停止繪畫 (Stop Drawing)</div>
                        <pre>{
  "type": "stop_drawing",
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>

                <div class="section">
                    <h3>📥 服務器回應訊息</h3>

                    <div class="message-example">
                        <div class="message-type">繪畫開始確認 (Drawing Started)</div>
                        <pre>{
  "type": "drawing_started",
  "session_id": "gesture_12345",
  "canvas_size": [720, 1280],
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">手勢狀態更新 (Gesture Status)</div>
                        <pre>{
  "type": "gesture_status",
  "current_gesture": "drawing",
  "fingers_up": [false, true, false, false, false],
  "drawing_position": [320, 240],
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">畫布更新 (Canvas Update)</div>
                        <pre>{
  "type": "canvas_update",
  "canvas_base64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "stroke_count": 15,
  "current_color": "blue",
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">AI識別結果 (AI Recognition)</div>
                        <pre>{
  "type": "recognition_result",
  "recognized_shape": "circle",
  "confidence": 0.87,
  "message": "我看到一個圓形！(非常確定)",
  "timestamp": 1640995200.123
}</pre>
                    </div>

                    <div class="message-example">
                        <div class="message-type">錯誤訊息 (Error Message)</div>
                        <pre>{
  "type": "error",
  "message": "MediaPipe 初始化失敗",
  "error_code": "MEDIA_PIPE_ERROR",
  "timestamp": 1640995200.123
}</pre>
                    </div>
                </div>

                <div class="section">
                    <h3>🤏 手勢說明</h3>
                    <table class="table">
                        <tr>
                            <th>手勢</th>
                            <th>說明</th>
                            <th>對應動作</th>
                        </tr>
                        <tr>
                            <td><strong>👆 食指伸出</strong></td>
                            <td>僅食指伸直，其他手指彎曲</td>
                            <td>繪畫模式 - 使用食指尖端繪畫</td>
                        </tr>
                        <tr>
                            <td><strong>✌️ 雙指伸出</strong></td>
                            <td>食指和中指伸直</td>
                            <td>選擇模式 - 橡皮擦功能</td>
                        </tr>
                        <tr>
                            <td><strong>✋ 五指全開</strong></td>
                            <td>所有手指完全伸直</td>
                            <td>清空模式 - 清空整個畫布</td>
                        </tr>
                    </table>
                </div>

                <div class="section">
                    <h3>⚙️ 效能參數</h3>
                    <table class="table">
                        <tr><th>參數</th><th>建議值</th><th>說明</th></tr>
                        <tr><td>幀率</td><td>20-30 FPS</td><td>平衡即時性和處理效能</td></tr>
                        <tr><td>影像解析度</td><td>動態適應</td><td>自動適應攝影機實際解析度 (如 1920x1080, 1280x720 等)</td></tr>
                        <tr><td>手勢穩定性</td><td>3幀確認</td><td>避免抖動誤觸</td></tr>
                        <tr><td>網路延遲</td><td>< 50ms</td><td>確保即時互動體驗</td></tr>
                    </table>
                </div>

                <div class="section">
                    <h3>💻 使用範例</h3>
                    <div class="code-block">// JavaScript 手勢繪畫整合範例
class GestureDrawingClient {
    constructor() {
        this.ws = null;
        this.canvas = document.getElementById('drawing-canvas');
        this.setupWebSocket();
        this.setupCamera();
    }

    setupWebSocket() {
        this.ws = new WebSocket('ws://localhost:8896/ws/drawing/gesture');

        this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleServerMessage(data);
        };
    }

    async startDrawing() {
        // 啟動攝影機
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        this.videoElement.srcObject = stream;

        // 發送啟動訊息
        this.ws.send(JSON.stringify({
            type: 'start_gesture_drawing',
            mode: 'gesture_control',
            color: 'blue',
            canvas_size: [720, 1280],
            timestamp: Date.now() / 1000
        }));
    }

    handleServerMessage(data) {
        switch(data.type) {
            case 'canvas_update':
                this.updateCanvas(data.canvas_base64);
                break;
            case 'gesture_status':
                this.updateGestureHints(data.current_gesture);
                break;
            case 'recognition_result':
                this.showRecognitionResult(data);
                break;
        }
    }
}</div>
                </div>
            </div>
        </div>

        <!-- 關閉代碼參考 -->
        <div class="endpoint-card">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
                <div>
                    <span class="endpoint-method">REF</span>
                    <span class="endpoint-url">WebSocket 關閉代碼</span>
                    <div class="endpoint-description">標準關閉代碼定義</div>
                </div>
                <span class="toggle-arrow">▶</span>
            </div>
            <div class="endpoint-content">
                <table class="table">
                    <tr>
                        <th>代碼</th>
                        <th>名稱</th>
                        <th>說明</th>
                        <th>觸發條件</th>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">1000</span></td>
                        <td>CLOSE_NORMAL</td>
                        <td>正常關閉</td>
                        <td>前端呼叫 close() 或正常結束</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">1001</span></td>
                        <td>CLOSE_GOING_AWAY</td>
                        <td>端點離開</td>
                        <td>頁面重新載入、導航離開</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-error">1006</span></td>
                        <td>CLOSE_ABNORMAL</td>
                        <td>異常關閉</td>
                        <td>網路中斷、伺服器崩潰</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-error">1008</span></td>
                        <td>CLOSE_POLICY_VIOLATION</td>
                        <td>違反政策</td>
                        <td>訊息格式錯誤、無效數據</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-error">1011</span></td>
                        <td>CLOSE_SERVER_ERROR</td>
                        <td>伺服器錯誤</td>
                        <td>內部處理錯誤</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
